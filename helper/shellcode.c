#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <sys/mman.h>


//char code[] = "\x31\xc0\x99\xb2\x0c\xff\xc0\x89\xc7\x48\x8d\x35\x12\x00\x00\x00\x0f\x05\xb2\x2a\x31\xc0\xff\xc0\xf6\xe2\x89\xc7\x31\xc0\xb0\x3c\x0f\x05\x2e\x2e\x2e\x2e\x57\x4f\x4f\x44\x59\x2e\x2e\x2e\x2e\x0c";
//char code[] = "\x48\x31\xc0\xb0\x01\xbf\x01\x00\x00\x00\x48\x8d\x35\x13\x00\x00\x00\xba\x0f\x00\x00\x00\x0f\x05\x48\x31\xc0\xb0\x3c\xbf\x2a\x00\x00\x00\x0f\x05\x2e\x2e\x2e\x2e\x57\x4f\x4f\x44\x59\x2e\x2e\x2e\x2e\x0a\x0d";
//char code[] = "\x31\xed\x49\x89\xd1\x5e\x48\x89\xe2\x48\x83\xe4\xf0\x50\x54\x45\x31\xc0\x31\xc9\x48\x8d\x3d\xce\x00\x00\x00\xff\x15\x4f\x2f\x00\x00\xf4\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x0f\x1f\x40\x00\x48\x8d\x3d\x91\x2f\x00\x00\x48\x8d\x05\x8a\x2f\x00\x00\x48\x39\xf8\x74\x15\x48\x8b\x05\x2e\x2f\x00\x00\x48\x85\xc0\x74\x09\xff\xe0\x0f\x1f\x80\x00\x00\x00\x00\xc3\x0f\x1f\x80\x00\x00\x00\x00\x48\x8d\x3d\x61\x2f\x00\x00\x48\x8d\x35\x5a\x2f\x00\x00\x48\x29\xfe\x48\x89\xf0\x48\xc1\xee\x3f\x48\xc1\xf8\x03\x48\x01\xc6\x48\xd1\xfe\x74\x14\x48\x8b\x05\xfd\x2e\x00\x00\x48\x85\xc0\x74\x08\xff\xe0\x66\x0f\x1f\x44\x00\x00\xc3\x0f\x1f\x80\x00\x00\x00\x00\xf3\x0f\x1e\xfa\x80\x3d\x1d\x2f\x00\x00\x00\x75\x2b\x55\x48\x83\x3d\xda\x2e\x00\x00\x00\x48\x89\xe5\x74\x0c\x48\x8b\x3d\xfe\x2e\x00\x00\xe8\x29\xff\xff\xff\xe8\x64\xff\xff\xff\xc6\x05\xf5\x2e\x00\x00\x01\x5d\xc3\x0f\x1f\x00\xc3\x0f\x1f\x80\x00\x00\x00\x00\xf3\x0f\x1e\xfa\xe9\x77\xff\xff\xff\x55\x48\x89\xe5\x48\x8d\x05\xc0\x0e\x00\x00\x48\x89\xc7\xe8\xe4\xfe\xff\xff\xb8\x00\x00\x00\x00\x5d\xc3";
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <stdint.h>
#include <unistd.h>
#include <stdio.h>
#include <stdint.h>
#include <sys/mman.h>
#include <unistd.h>

char shellcode[] = 
    "\x52"                                // push rdx
    "\xbf\x00\x00\x40\x00"                // mov rdi, 0x400000 (adresse)
    "\xbe\x00\x10\x00\x00"                // mov rsi, 0x1000 (taille)
    "\xba\x07\x00\x00\x00"                // mov rdx, 0x7 (PROT_READ | PROT_WRITE | PROT_EXEC)
    "\xb8\x0a\x00\x00\x00"                // mov rax, 0xa (syscall: mprotect)
    "\x0f\x05"                            // syscall

    "\xbf\x01\x00\x00\x00"                // mov rdi, 1 (stdout)
    "\x48\xbe\x2e\x2e\x2e\x2e\x57\x4f\x4f\x44\x59" // mov rsi, msg (adresse du message)
    "\xba\x0e\x00\x00\x00"                // mov rdx, 0xe (longueur du message)
    "\xb8\x01\x00\x00\x00"                // mov rax, 1 (syscall: write)
    "\x0f\x05"                            // syscall

    "\xbf\x50\x10\x00\x00"                // mov rdi, entry_offset (0x1050)
    "\x5a"                                // pop rdx
    "\xff\xe7"                            // jmp rdi

    "\x2e\x2e\x2e\x2e"                    // "...."
    "\x57\x4f\x4f\x44\x59"                // "WOODY"
    "\x2e\x2e\x2e\x2e\x0a";                // "....\n"

int main() {
    // Protéger la mémoire pour que le shellcode soit exécutable
    if (mprotect((void*)((uintptr_t)shellcode & ~0xFFF), 4096, PROT_READ | PROT_WRITE | PROT_EXEC) == -1) {
        perror("mprotect");
        return 1;
    }

    printf("Shellcode Length:  %lu\n", sizeof(shellcode));

    int (*func)();
    func = (int (*)()) shellcode;
    (int)(*func)();
    
    return 0;
}

